<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Crushing Latency with Vert.x</title>

  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/reveal.css">
  <link rel="stylesheet" href="css/theme/white.css">

  <!-- Theme used for syntax highlighting of code -->
  <link rel="stylesheet" href="lib/css/monokai.css">

  <!-- font awesome -->
  <link href="css/fontawesome/css/all.min.css" rel="stylesheet">
  <script defer src="css/fontawesome/js/all.min.js"></script>

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
  </script>

  <style>

    img {
      border: none !important;
      box-shadow: none !important;
    }

    /* Process colors */
    .proc-0 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #ee1111;
    }

    .proc-1 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #e3a21a;
    }

    .proc-2 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #2b5797;
    }
    .proc-3 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #eff4ff;
    }
    .proc-4 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #1d1d1d;
    }
    .proc-5 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #7e3878;
    }
    .proc-6 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #ff0097;
    }
    .proc-7 {
      display: inline-block;
      width:120px;
      height:120px;
      background-color: #00a300;
    }

    .proc-wait {
      display: inline-block;
      width:60px;
      height:120px;
    }

    .proc-hl {
      border-top: 2rem solid;
      border-color: black;
    }

    .proc-short {
      width:60px;
    }

    .proc-micro {
      width:10px;
    }

    .proc-switch {
      display: inline-block;
      width:20px;
      height:120px;
      background-color: #1d1d1d;
    }
  </style>
</head>
<body>
<div class="reveal">
  <div class="slides">
    <section style="text-align: left">
      <h1>Crushing Latency</h1>
      <h2>with Vert.x</h2>

      <span style="font-size: 0.6em">
        <strong>Paulo Lopes</strong>
        <i class="fab fa-redhat"></i>
        <br/>Principal Software Engineer
      </span>
    </section>

    <section>
      <img data-src="media/loading.gif" class="stretch">
    </section>

    <section style="text-align: left;">
      <strong>latency</strong> <small>noun</small><br/>
      &nbsp;&nbsp;&nbsp;&nbsp;<small><em>la¬∑‚Äãten¬∑cy | \ ÀàlƒÅ-t·µän(t)-sƒì \</em></small>

      <blockquote>
        <img data-src="media/latency-explained.png">
        <small><em>Network latency is the term used to indicate any kind of delay that happens in data communication over a network.</em><br><br>(techopedia.com)</small>
      </blockquote>

    </section>

    <section>
      <h2>Latency by the numbers</h2>

      <ul>
        <li><strong>Amazon</strong>: every 100ms of latency costs 1% in sales<br>
          <small><a href="http://home.blarg.net/~glinden/StanfordDataMining.2006-11-29.ppt">http://home.blarg.net/~glinden/StanfordDataMining.2006-11-29.ppt</a></small></li>
        <li><strong>Google</strong>: an extra 0.5 seconds in search page generation time dropped traffic by 20%<br>
          <small><a href="http://glinden.blogspot.com/2006/11/marissa-mayer-at-web-20.html">http://glinden.blogspot.com/2006/11/marissa-mayer-at-web-20.html</a></small></li>
        <li><strong>A broker</strong>: could lose $4 million in revenues per millisecond if their electronic trading platform is 5 milliseconds behind the competition<br>
        <small><a href="http://www.tabbgroup.com/PublicationDetail.aspx?PublicationID=346">http://www.tabbgroup.com/PublicationDetail.aspx?PublicationID=346</a></small></li>
      </ul>

    </section>

    <section>
      <h3>Latency is not the problem</h3>
      <h2 class="fragment">it's the symptom!</h2>
    </section>

    <section>
      <h2><small>2007:</small> Dan Pritchett</h2>

      <ul>
        <li class="fragment">Loosely Couple Components</li>
        <li class="fragment">Use Asynchronous Interfaces</li>
        <li class="fragment">Horizontally Scale from the Start</li>
        <li class="fragment">Create an Active/Active Architecture</li>
        <li class="fragment">Use a <strong>BASE</strong> instead of <strong>ACID</strong> Shared Storage Mode</li>
      </ul>

      <p>
        <small>
          <a href="https://www.infoq.com/articles/pritchett-latency/">www.infoq.com/articles/pritchett-latency</a>
        </small>
      </p>
    </section>

    <section>
      <h2><small>2011:</small> Vert.x</h2>

      <ul>
        <li class="fragment">Loosely Couple Components <small>(event bus)</small></li>
        <li class="fragment">Use Asynchronous Interfaces<small>(non blocking I/O)</small></li>
        <li class="fragment">Horizontally Scale from the Start <small>(clustered)</small></li>
      </ul>

      <p>
        <em>Eclipse Vert.x is a tool-kit for building reactive applications on the JVM.</em>

        <small>
          <a href="https://vertx.io/">https://vertx.io/</a>
        </small>
      </p>
    </section>

    <section>
      <h2>Why Non-Blocking I/O?</h2>
    </section>

    <section>
      <h3>5ms / req time</h3>

      <div>
        <div class="proc-0"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-6"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-7"><div class="fragment fade-in-then-out proc-hl"></div></div>
        ...
      </div>

      <pre><code data-trim class="bash">
        # In optimal circumstances

        1 Thread => 200 req/sec
        8 Cores => 1600 req/sec
      </code></pre>
    </section>

    <section>
      <h3>req time grows as threads fight for execution time</h3>

      <div>
        <div class="proc-0"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-6"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-7"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        ...
      </div>

      <pre><code data-trim class="bash">
      # PROCESS STATE CODES
      #   D    Uninterruptible sleep (usually IO)

      ps aux | awk '$8 ~ /D/  { print $0 }'
      root 9324 0.0 0.0 8316 436 ? D<   Oct15 0:00 /usr/bin/java...
      </code></pre>
    </section>

    <section>
      <h3>when load is higher than max threads queuing builds up</h3>

      <div>
        <div class="proc-0"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-1 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-5 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-6"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-5 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-wait"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-7"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="fragment fade-in-then-out proc-switch"></div>
        <div class="proc-1 proc-short"><div class="fragment fade-in-then-out proc-hl"></div></div>
        ...
      </div>

      <pre><code data-trim class="bash">
      # git@github.com:tsuna/contextswitch.git

      ./cpubench.sh
      model name : Intel(R) Core(TM) i7-8650U CPU @ 1.90GHz
      1 physical CPUs, 4 cores/CPU, 2 hardware threads/core
      2000000  thread context switches in 2231974869ns
                                          (1116.0ns/ctxsw)
      </code></pre>
    </section>

    <section>
      <h2>Practical example: <small>Tomcat 9.0</small></h2>

      <ul>
        <li>Default <code>maxThreads</code>: <strong>200</strong></li>
        <li class="fragment">Avg req time: <strong>5ms</strong></li>
        <li class="fragment">Hypothetical High load: <strong>1000 req</strong></li>
        <li class="fragment">Wasted wait/queue time: <strong>(1000 / 200 - 1) * 5 = <big>20ms</big></strong></li>
      </ul>

      <p>
        <small>
          <a href="https://tomcat.apache.org/tomcat-9.0-doc/config/executor.html">https://tomcat.apache.org/tomcat-9.0-doc/config/executor.html</a></small>
      </p>
    </section>

    <section>
      <h4><em>at max utilization</em></h4>
      <h2 class="fragment">CPU is mostly waiting</h2>
    </section>

    <section>
      <h2>Non-Blocking I/O</h2>
    </section>

    <section>

      <h2>Vert.x</h2>

      <div style="display: inline-block; width: 45%; float: left;">
        <div style="text-align: left;">
          <big><b>Events</b></big>
        </div>

        <img data-src="media/eventloop.png">
      </div>

      <div style="display: inline-block; width: 45%; text-align: left">
        <div class="proc-0"><div class="fragment fade-in-then-out proc-hl" data-fragment-index="1"></div><div class="fragment fade-in-then-out proc-hl" data-fragment-index="3"></div><div class="fragment fade-in-then-out proc-hl" data-fragment-index="5"></div><div class="fragment fade-in-then-out proc-hl" data-fragment-index="7"></div></div> Request Handler<br/>
        <div class="proc-1"><div class="fragment fade-in-then-out proc-hl" data-fragment-index="2"></div></div> AUTH Handler<br/>
        <div class="proc-5"><div class="fragment fade-in-then-out proc-hl" data-fragment-index="4"></div></div> DB Handler<br/>
        <div class="proc-6"><div class="fragment fade-in-then-out proc-hl" data-fragment-index="6"></div></div> JSON Handler
      </div>

    </section>

    <section>
      <h2>1 CPU core fully used!</h2>
    </section>

    <section>
      <h2>Vert.x</h2>
      <h4>Intel(R) Core(TM) i7-8650U CPU @ 1.90GHz</h4>

      <span><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>
      <span class="fragment" data-fragment-index="1"><img width="20%" heigth="20%" src="media/eventloop.png"></span>

    </section>

    <section>
      <h2>100% CPU cores used!</h2>
    </section>

    <section>
      <h2>Benchmarking <span class="fragment">is hard</span></h2>

      <ul>
        <li class="fragment"><em>Meaningful benchmarks are even harder</em></li>
        <li class="fragment">Techempower Framework Benchmarks</li>
        <ul>
          <li class="fragment">Contributors: <strong>528</strong></li>
          <li class="fragment">Pull Requests: <strong>4022</strong></li>
          <li class="fragment">Commits: <strong>11095</strong></li>
        </ul>
      </ul>

      <p>
        <small>
          <a href="https://github.com/TechEmpower/FrameworkBenchmarks/">https://github.com/TechEmpower/FrameworkBenchmarks</a>
        </small>
      </p>
    </section>

    <section>
      <h2>Baseline: JAX-RS</h2>

      <ul>
        <li>Blocking API</li>
        <li>Thread Based</li>
        <li>Java</li>
      </ul>

    </section>

    <section>
      <div style="display: inline-block; width: 45%; float: left;">
        <h2>Baseline</h2>

        <pre><code data-trim data-noescape>
        <small>
        @GET
        @Path("/queries")
        World[]
        queries(@QueryParam("queries") String queries)
        {
          World[] worlds = new World[queries];
          Session session = emf.createEntityManager();

          for (int i = 0; i < queries; i++) {
            worlds[i] = session
              .byId(World.class)
              .load(randomWorld());
          }

          return worlds;
        }
        </small></code></pre>
      </div>

      <div style="display: inline-block; width: 45%; text-align: left">
        <h2>vert.x-web</h2>

        <pre><code data-trim data-noescape class="java">
        <small>
        void
        queriesHandler(final RoutingContext ctx) {

          World[] worlds = new World[getQueries(ctx)];
          AtomicInteger cnt = new AtomicInteger();

          for (int i = 0; i < getQueries(ctx); i++) {
            db.preparedQuery(FIND_WORLD, ..., res -> {
              final Row row = res.result()
                          .iterator()
                          .next();

              worlds[cnt.incrementAndGet()] =
                new World(row);

              if (cnt.get() == queries) {
                ctx.response()
                  .end(Json.encodeToBuffer(worlds));
              }
            });
          }
        }
        </small></code></pre>
      </div>
    </section>

    <section data-background-image="media/baseline.png" data-background-size="contain">

    </section>

    <section>
      <h2>Simple results</h2>

      <ul>
        <li>Vert.x: <big><strong>37,157</strong></big> req/s</li>
        <li>Jax-RS: <big><strong>14,493</strong></big> req/s</li>
      </ul>
    </section>

    <section>
      <h1>Polyglot</h1>
      <h4>English - ÁÆÄ‰Ωì‰∏≠Êñá - Portugu√™s</h4>
    </section>

    <section>
      <h3>What happens when you say Hello?</h3>

      <div>
        <div class="proc-5"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-1 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5 proc-micro"><div class="fragment fade-in-then-out proc-hl"></div></div>
        <div class="proc-5"><div class="fragment fade-in-then-out proc-hl"></div></div>
      </div>


      <pre><code data-trim>
      function handler (context) {
        // the exchange context
        context
        // get the response object
        .response()
        // send the message and end
        // the response
        .end('‰Ω†Â•Ω');
      }
      </code></pre>
    </section>

    <section>
      <h3>Getting the response object</h3>

      <pre><code data-trim data-line-numbers="5-7">
        this.response =  function() {
          var __args = arguments;
          if (__args.length === 0) {
            if (that.cachedresponse == null) {
              that.cachedresponse = utils.convReturnVertxGen(
                HttpServerResponse,
                j_routingContext["response()"]());
            }
            return that.cachedresponse;
          } else if (typeof __super_response != 'undefined') {
            return __super_response.apply(this, __args);
          }
          else throw new TypeError('invalid arguments');
        };
      </code></pre>
    </section>

    <section>
      <h2>In a nutshell</h2>

      <ul>
        <li>Lots of conversions (GC)</li>
        <li>Constant switch from JS engine to Java code
          (somehow similar to context switching)</li>
        <li>Not suited for performance</li>
        <li><strong>JIT optimization will stop at language cross</strong></li>
      </ul>

    </section>

    <section>
      <h2>Node.js</h2>

      <img data-src="media/libuv.png" alt="libuv" class="stretch">

    </section>

    <section>
      <h2>JIT can't optimize it all</h2>
      <img data-src="media/iceberg.jpg" alt="iceberg" class="stretch">
    </section>

    <section>
      <h1>ü§î</h1>
      <h2>Can we make polyglot fast?</h2>
    </section>

    <section>
      <img data-src="media/graal.jpg" alt="graalvm" class="stretch">

      <p>
        <small>
          <a href="https://graalvm.org">https://graalvm.org</a></small>
      </p>
    </section>


    <section>
      <h2>GraalVM: In a nutshell</h2>

      <ul>
        <li><strike>Lots of conversions (GC)</strike></li>
        <li><strike>Constant switch from JS engine to Java code
          (somehow similar to context switching)</strike></li>
        <li><strike>Not suited for performance</strike></li>
        <li><strike><strong>JIT optimization will stop at language cross</strong></strike></li>
      </ul>
    </section>

    <section>
      <h2>ES4X</h2>

      <img data-src="media/es4x.png" class="stretch">

      <div>
        <ul>
          <li class="fragment">GraalVM based</li>
          <li class="fragment">Vert.x for I/O</li>
          <li class="fragment">commonjs and ESM loader</li>
          <li class="fragment">debug/profile chrome-devtools</li>
        </ul>
      </div>

      <p>
        <small>
          <a href="https://reactiverse.io/es4x">https://reactiverse.io/es4x</a></small>
      </p>
    </section>

    <section>
      <h2>ES4X design principles</h2>

      <ul>
        <li>GraalJS (for fast JS runtime)</li>
        <li>Vert.x (for fast I/O + event loops)</li>
        <li>GraalVM (for full JIT)</li>
        <li><code>.d.ts</code> (for IDE support)</li>
      </ul>

      <pre><code data-trim data-noescape class="bash">
      <small>
      github.com/AlDanial/cloc v 1.72  T=0.09 s (401.5 files/s, 51963.8 lines/s)
      -------------------------------------------------------------------------------
      Language                     files          blank        comment           code
      -------------------------------------------------------------------------------
      Java                            26            389            683           1778
      JavaScript                       9            201            253           1226
      -------------------------------------------------------------------------------
      SUM:                            35            590            936           3004
      -------------------------------------------------------------------------------
      </small>
      </code></pre>
    </section>

    <section>
      <h2>Node.js <small>vs</small> ES4X</h2>

      <div style="display: inline-block; width: 45%; float: left;">
        <pre><code data-trim data-noescape>
        <small>
        const cluster = require('cluster'),
          numCPUs = require('os').cpus().length,
          express = require('express');

        if (cluster.isMaster) {
          for (let i = 0; i < numCPUs; i++)
            cluster.fork();
        } else {
          const app = module.exports = express();
          app.get('/plaintext', (req, res) =>
            res
              .header('Content-Type', 'text/plain')
              .send('Hello, World!'));
        }
        </small></code></pre>
      </div>

      <div style="display: inline-block; width: 45%; text-align: left">
        <pre><code data-trim data-noescape>
        <small>
        import { Router } from '@vertx/web';

        const app = Router.router(vertx);

        app.get("/plaintext").handler(ctx => {
          ctx.response()
            .putHeader("Content-Type", "text/plain")
            .end('Hello, World!');
        });
        </small></code></pre>
      </div>
    </section>

    <section data-background-image="media/es4x-single.png" data-background-size="contain">

    </section>

    <section data-background-image="media/es4x-multi.png" data-background-size="contain">

    </section>

    <section>
      <h2>Polyglot GraalVM is fast.</h2>
      <h4>what about latency?</h4>
    </section>

    <section data-background-image="media/latency.png" data-background-size="contain">

    </section>

    <section style="text-align: left">
      <h1>Conclusion</h1>

      <ul>
        <li>latency is not a problem, it's a symptom</li>
        <li>non-blocking to fully use the CPU</li>
        <li><strong>use vert.x</strong></li>
        <li>polyglot is fine</li>
        <li>use graalvm for polyglot JIT optimizations</li>
        <li>node can be slow for server applications</li>
        <li><strong>use ES4X</strong></li>
      </ul>
    </section>

    <section style="text-align: left">
      <h1>Thank you!</h1>

      <ul>
        <li><i class="fab fa-twitter"></i> <code>@pml0pes</code></li>
        <li><i class="fab fa-github"></i> <code>pmlopes</code></li>
        <li><a href="https://reactiverse.io/es4x">https://reactiverse.io/es4x</a></li>
        <li><a href="https://vertx.io">https://vertx.io</a></li>
        <li><a href="https://graalvm.org">https://graalvm.org</a></li>
      </ul>
    </section>

  </div>
</div>

<script src="js/reveal.js"></script>

<script>
  // More info about config & dependencies:
  // - https://github.com/hakimel/reveal.js#configuration
  // - https://github.com/hakimel/reveal.js#dependencies
  Reveal.initialize({

    controls: true,
    progress: true,
    center: true,
    hash: true,

    dependencies: [
      {src: 'plugin/markdown/marked.js'},
      {src: 'plugin/markdown/markdown.js'},
      {src: 'plugin/notes/notes.js', async: true},
      {src: 'plugin/highlight/highlight.js', async: true}
    ]
  });
</script>
</body>
</html>
